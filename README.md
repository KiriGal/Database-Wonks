# Курсовой проект по Базам Данных

> **Внимание**: Данный проект описывает структуру базы данных на основе СУБД PostgreSQL. Дополнительно была реализованна технология отказоустойчивого кластера на основе Patroni

## Оглавление

1. [Предварительные требования](#предварительные-требования)
2. [Быстрый старт](#быстрый-старт)
3. [Проверка etcd-кластера](#проверка-etcd-кластера)
4. [Проверка Patroni-кластера](#проверка-patroni-кластера)
5. [Тест соединения через psql](#тест-подключения-через-psql)
6. [Просмотр статистики HAProxy](#просмотр-статистики-haproxy)
7. [Инициализация базы данных](#инициализация-базы-данных)
8. [Возможные проблемы](#возможные-проблемы)
9. [Рекомендации для продакшена](#рекомендации-для-продакшена)

---

## Предварительные требования

- Docker 20.10+
- Docker Compose 1.29+
- `git`

---

## Быстрый старт

1. Клонируйте репозиторий и перейдите в папку проекта:

   ```sh
   git clone https://github.com/KiriGal/Database-Wonks.git database && cd database
   ```

2. Запустите весь стек контейнеров:

   ```sh
   docker compose up -d --quiet-pull --wait
   ```

3. Проверьте, что все контейнеры запущены:

   ```sh
   docker compose ps
   ```

---

## Проверка etcd-кластера

```sh
docker exec docker_etcd0_1 \
  etcdctl endpoint status --write-out=table --cluster
```

Ожидаемый вывод:

```
+-------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
|     ENDPOINT      |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |
+-------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
| http://etcd1:2379 | 6125f400291004ec |  3.5.17 |   20 kB |     false |      false |         2 |         40 |                 40 |        |
| http://etcd2:2379 | f7c827122fd74deb |  3.5.17 |   20 kB |     false |      false |         2 |         40 |                 40 |        |
| http://etcd0:2379 | fe8d7aaaeb89e891 |  3.5.17 |   20 kB |      true |      false |         2 |         40 |                 40 |        |
+-------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
```

---

## Проверка Patroni-кластера

```sh
docker exec docker_patroni0_1 patronictl -c /patroni.yml list
```

Пример вывода:

```
+ Cluster: patroni (7447582066477301782) ---------+----+-----------+
| Member       | Host       | Role    | State     | TL | Lag in MB |
+--------------+------------+---------+-----------+----+-----------+
| 22ead2f09aab | 172.18.0.6 | Replica | streaming |  1 |         0 |
| b8cd8942ee30 | 172.18.0.7 | Replica | streaming |  1 |         0 |
| ecbe69945b54 | 172.18.0.8 | Leader  | running   |  1 |           |
+--------------+------------+---------+-----------+----+-----------+
```

---

## Тест подключения через psql

Подключаемся к primary через HAProxy-фронтенд:

```sh
psql -h localhost -p 5432 -U postgres
Password for user postgres:
psql (17.2)
```

---

## Просмотр статистики HAProxy

Откройте в браузере:

```
http://localhost:8080
```

Вы увидите **HAProxy Statistics Report**.

---

## Инициализация базы данных

При старте контейнеры запускают PostgreSQL, но схемы и наполнения нет. Чтобы инициализировать базу данных, выполните скрипты последовательно:

1. `schema.sql` — создание схемы и основных таблиц (DDL);
2. `variable.sql` — определение глобальных переменных и параметров;
3. `tables.sql` — создание всех таблиц приложения;
4. `views.sql` — создание представлений;
5. `indexes.sql` — создание индексов для оптимизации;
6. `functions.sql` — хранимые функции и процедуры;
7. `roles.sql` — создание ролей и прав доступа;
8. `triggers.sql` — триггеры на события (INSERT/UPDATE/DELETE);
9. `demodata.sql` — загрузка тестовых данных.

### Пример последовательного запуска через psql

```sh
# выставляем пароль и адрес
PGPASSWORD="supass" \
psql -h localhost -p 5432 -U postgres -d your_database \
  -f schema.sql \
  -f variable.sql \
  -f tables.sql \
  -f views.sql \
  -f indexes.sql \
  -f functions.sql \
  -f roles.sql \
  -f triggers.sql \
  -f demodata.sql
```

---

## Возможные проблемы

1. **Права доступа к каталогу данных**\
   Если при старте контейнеров Patroni жалуется на права в `./patroni-data*`, исправьте их:

   ```sh
   sudo chown -R 999:999 ./patroni-data*
   sudo chmod 0750     ./patroni-data*
   ```

2. **FATAL: data directory has invalid permissions**\
   Убедитесь, что UID 999 (postgres) владеет директорией и она имеет минимум `0750`.

---

*Автор: Гацевич Кирилл Сергеевич ФИТ-2-1*

